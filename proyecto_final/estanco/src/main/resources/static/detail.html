<!DOCTYPE html>
<html>
<head>
	<title>Tienda</title>
	<meta name="Description" content="Tabacos">
	<meta charset="utf-8">
	<meta lang="es">

	<!--Link necesario para el css de bootstrap-->
	<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.0.0-beta1/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-giJF6kkoqNQ00vy+HMDP7azOuL0xtbfIcaT9wjKHr8RbDVddVHyTfAAsrekwKmP1" crossorigin="anonymous">


	<style type="text/css">
		
		.estancoColors{
			background-color: #8B0000;
		}
	</style>

</head>
<body>

	<header class="container-fluid estancoColors py-1">

		<div class="row">
	
			<div class="container col-8 mt-3">
				<h1 class="display-1 text-warning text-center mt-4">ESTANCO VIRTUAL</h1>
				<div class="row">
					<p class="lead text-warning text-center">Bienvenido a tu estanco de confianza desde casa</p>
				</div>
			</div>
		
			<div class="container col-4">
				<img src="https://union-estanqueros.com/wp-content/uploads/2017/07/logo_solo.png" width="200"
				height="200" class="mt-0">
			</div>
		</div>
	</header>



	<nav class="navbar navbar-expand-lg navbar-light bg-light">
	  <a class="navbar-brand" href="#">
	      <img src="https://www.estancosalamanca35.com/uploads/kvpWTKOX/Logo.png" width="30" height="30" class="d-inline-block align-top" alt=""> EstancoVIRTUAL
	  </a>

	  <button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#navbarSupportedContent" aria-controls="navbarSupportedContent" aria-expanded="false" aria-label="Toggle navigation">
    	<span class="navbar-toggler-icon"></span>
  	 </button>

	  <div class="collapse navbar-collapse border border-2 justify-content-center" id="navbarNavAltMarkup">
	    <div class="navbar-nav">
	      <a class="nav-item nav-link" href="home.html">HOME</a>
	      <a class="nav-item nav-link active" href="detail.html">DETAIL</a>
	      <a class="nav-item nav-link" href="contact.html">CONTACT</a>
	    </div>
	  </div>
	</nav>


	<div id= "tabaco-structure" class="container-fluid">
		
		<div class="row py-2 estancoColors align-items-center">

			<!--Boton desplegable de bootstrap para poder elegir el tabaco que nos muestra-->

			<div class="col-2">
				<div class="dropdown">
				  <button class="btn btn-warning dropdown-toggle" type="button" id="dropdownMenuButton2" data-bs-toggle="dropdown" aria-expanded="false">
				    Elije el tabaco
				  </button>
				  <ul class="dropdown-menu dropdown-menu-light" aria-labelledby="dropdownMenuButton2">
				    <li><a class="dropdown-item active" href="#tabacoIndustrial">Tabaco Industrial</a></li>
				    <li><a class="dropdown-item" href="#tabacoLiar"> Tabaco de Liar</a></li>
				  </ul>
				</div>
			</div>

			<div class="col-8">
				<h1 class="display-3 text-warning text-center">Tabacos</h1>
			</div>

			<div class="col-2" style="text-align: right;">
				<button class="btn btn-warning btn-sm" type="button" id="carritoButton">
					<img src="imgs/carrito.png" width="30px" height="30px">
				</button> 
			</div>
		</div>

		<div class="container py-5 col">

			<div class="modal fade" id="articleModal" tabindex="-1" aria-labelledby="exampleModalLabel" aria-hidden="true">
			  <div class="modal-dialog">
			    <div class="modal-content">
			      <div class="modal-header">
			        <h5 class="modal-title" id="modalTitle">Nuevo Articulo</h5>
			        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
			      </div>
			      <div class="modal-body" id="modalBody">

		      		<div class="container-fluid text-center my-3">
						<p class="h5" id="marca-tabaco">VACIO</p>
					</div>

					<div class="container-fluid text-center my-3">
						<p class="h5" id="precio-tabaco">VACIO</p>
					</div>
			        
			       <div class="container-fluid text-center my-3">
						<label class="h5" for="unidades">UNIDADES (1-20)</p>
						<input type="number" id="unidades" min="1" max="20">
					</div>
			        
			      </div>
			      <div class="modal-footer">
			      	 <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
			        <button type="button" class="btn btn-primary" id="buttonAdd">Add to chart</button>
			      </div>
			    </div>
			  </div>
			</div>

			<!-- Modal para sacar la info por pantalla del carrito -->

			<div class="modal fade" id="carritoModal" tabindex="-1" aria-labelledby="exampleModalLabel" aria-hidden="true">
				<div class="modal-dialog modal-dialog-centered modal-xl">
				  <div class="modal-content">
					<div class="modal-header">
					  <h5 class="modal-title" id="modalTitle">Shopping Cart</h5>
					  <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
					</div>
					<div class="modal-body" id="modalBody">
				
						<div class="container-fluid">
							<div class="row">
								<div class="col-6" id="idProductos" style="text-align: left;">
									<div class="container-fluid mb-3">
										<p class="h5" style="color:navy;">PRODUCTS</p>
									</div>
									<!--Aqui van los nombres de cada producto-->
								</div>
								<div class="col-3" id="uds" style="text-align: center;">
									<div class="container-fluid mb-3" >
										<p class="h5" style="color:navy;">UDS</p>
									</div>
									<!--Aqui van las unidades cada producto-->
								</div>
								<div class="col-3" id="precioProducto" style="text-align: center;">
									<div class="container-fluid mb-3">
										<p class="h5" style="color:navy;">TOTAL</p>
									</div>
									<!--Aqui va el precio total de cada producto-->
								</div>
							</div>
						</div>
						<div class="container-fluid mt-3">
							<div class="row">
								<div class="container-fluid col-6">
									<p class="h5"> TOTAL AMOUNT </p>
								</div>
								<div class="container-fluid col-6">
									<p class="h5" id="total-amount" style="text-align: right"></p>
								</div>
							</div>
						</div>
					  
					</div>
					<div class="modal-footer">
						 <button type="button" class="btn btn-secondary" data-bs-dismiss="modal" id="cancel">Cancel</button>
					 	 <button type="button" class="btn btn-primary" id="finish">Finish Purchase</button>
					</div>
				  </div>
				</div>
			</div>			

				<!--Piensa en que la row es como un container flex box-->

			<div class="row" id="tabaco-grid">

				<!--Cada card tiene un width determinado de 20rem-->
				<!--Indicamos que el div padre ocupe las columnas necesarias que le exiga el hijo-->
				<!--Cuando se pase de 12: salto de linea-->

			</div>

		</div>

	</div>


	<footer class="container-fluid estancoColors py-5 mt-5">

		<div class="container-fluid rounded border border-2 border-warning col-6">
			<p class="lead text-warning text-center">Derechos reservados</p>
		</div>

	</footer>

	<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.0.0-beta3/dist/js/bootstrap.bundle.min.js" integrity="sha384-JEW9xMcG8R+pH31jmWH6WWP0WintQrMb4s7ZOdauHnUtxwoG2vI5DkLtS3qm9Ekf" crossorigin="anonymous"></script>
	<script src="http://code.jquery.com/jquery-1.11.0.min.js"></script>

</body>

<script type="text/javascript">

	//inicializo el JSON que me van a devolver del back
	var industrialSearchModel={};
	var liarSearchModel={};

	//Array de JSONs de lineas de compra
	var arrayTabacos = [];

	//Nada mas entrar en la pagina hago los dos fetch y me guardo la info en las variables

	loadTabacoIndustrial();
	loadTabacoLiar();

	//CUIDADO que los fetch son asincronos si ejecutas aqui formGrid no funciona porque puede ser que 
	//Este ejecutando la linea sin haber recibido la respuesta del fetch
	//por eso he metido el formGrid dentro del fetch


	//Ahora añado un eventListener a window que se activa cada vez que cambia la # de la url

	window.addEventListener("hashchange",function(){

		let hashValue= window.location.hash;

		if(hashValue=="#tabacoLiar"){
			formGrid("tabacoLiar");
		}

		if(hashValue=="#tabacoIndustrial"){
			formGrid("tabacoIndustrial");
		}

	});

	
	function loadTabacoIndustrial(){


		fetch("http://localHost:8080/api/tabacoIndustrial",{

			method:"GET",
			headers:{
				"Content-Type":"application/json",
				"Accept": "application/json"
			}

		})

		.then(function(response){
			if(response.ok){

				return response.json();
			}else{
				throw response;
			}
		})

		.then(function (r){

			industrialSearchModel=r;
			formGrid("tabacoIndustrial");

		})

		.catch(error=>console.error(error))
	}

	function loadTabacoLiar(){


		fetch("http://localHost:8080/api/tabacoLiar",{

			method:"GET",
			headers:{
				"Content-Type":"application/json",
				"Accept": "application/json"
			}

		})

		.then(function(response){
			if(response.ok){

				return response.json();
			}else{
				throw response;
			}
		})

		.then(function (r){

			liarSearchModel=r;

		})

		.catch(error=>console.error(error))
	}

	function formGrid(type){
		
		
		let html="";
		let listCajetas=null;
		let counter=null;

		if(type=="tabacoIndustrial"){
			listCajetas = industrialSearchModel.items;
			counter= industrialSearchModel.count;
		}else{
			listCajetas=liarSearchModel.items;
			counter=liarSearchModel.count;
		}
			

		//La unica variable que no es igual entre tabaco industrial y liar es cigarrillos vs gramos
		//Asi que eso lo guardo en una variable a parte

		for (let i=0; i<counter; i++){
			//creacion de las cards

			let cajeta= listCajetas[i];
			let aux=null;
			

			if(type=="tabacoIndustrial"){
				aux=cajeta.cigarrillos;
			}else{
				aux=cajeta.gramos;
			}
				

			html+= '<div class="col">'+
			 '<div class="card m-auto my-5" style="width: 20rem">'+
			 `<img class="card-img-top" src="${cajeta.imagen}" height="400" alt="Card image cap">`+
			 '<div class="card-body">'+
			 `<h5 class="card-title">${cajeta.marca}</h5>`+
			 `<p class="card-text">${cajeta.descripcion}</p>`+
			 `<p class="card-text">Precio: ${cajeta.precio}</p>`+
			 `<p class="card-text">Cantidad: ${aux}</p>`+
			 `<button class="btn btn-primary button-card" id="btn${i}" type="button">Comprar</button>`+
			 '</div>'+
			 '</div>'+
			 '</div>';

		}

		const myGrid= document.getElementById("tabaco-grid");
		myGrid.innerHTML="";
		myGrid.innerHTML=html;
		console.log("punto de control");
		debugger
		cardsEvents(type);
		cartEvent();

	}
	
	//PARA CALCULAR EL TOTAL
	var totalAm = 0;
	var anterior = 0;

	function cartEvent(){

		//Evento de pulsar el boton del carrito
		var add = document.getElementById("carritoButton");
		add.addEventListener("click",function(e){

			//LOGICA PARA MOSTRAR PRODUCTOS
			while(anterior < arrayTabacos.length){

				//SACO INFO DEL PRODUCTO
				var marca = arrayTabacos[anterior].nombre;
				console.log(marca);
				var image = arrayTabacos[anterior].imagen;
				var tipo = arrayTabacos[anterior].tipo;
				console.log(tipo);
				var uds = arrayTabacos[anterior].cantidad;
				console.log(uds);
				var precio = arrayTabacos[anterior].precio;
				console.log(precio);
				var total = precio*uds;
				console.log(total);

				totalAm = totalAm + total;

				//SELECCIONO DIVS DONDE VOY A AÑADIR INFO
				var colProd = document.getElementById("idProductos");
				var colUds = document.getElementById("uds");
				var colTot = document.getElementById("precioProducto");

				//CREO DIV MARCA y AÑADO AL DIV
				var divMarca = document.createElement("div");
				divMarca.id = `divMarca${anterior}`;
				divMarca.className = "row";
				var pMarca = document.createElement("p");
				pMarca.textContent = marca + ": " + tipo;

				divMarca.appendChild(pMarca);
				colProd.appendChild(divMarca);

				//CREO DIV UNIDADES y AÑADO AL DIV
				var divUds = document.createElement("div");
				divUds.id = `divUds${anterior}`;
				var pUds = document.createElement("p");
				pUds.textContent = uds + " uds.";

				divUds.appendChild(pUds);
				colUds.appendChild(divUds);
				
				//CREO DIV TOTAL y AÑADO AL DIV
				var divTot = document.createElement("div");
				divTot.id = `divTot${anterior}`;
				var pTot = document.createElement("p");
				pTot.textContent = total + " $";

				divTot.appendChild(pTot);
				colTot.appendChild(divTot);		

				anterior++;
			}	

			anterior;

			document.getElementById("total-amount").innerHTML = totalAm + " $";

			const myModal = new bootstrap.Modal(document.getElementById('carritoModal'), {
				keyboard: false
			});

			myModal.show();

			
	})

	//Pulsa el boton cancel
	var cancel = document.getElementById("cancel");
	cancel.addEventListener("click",function(e){

		arrayTabacos.splice(0);
		//FALTA ELIMINAR LOS DIVS CREADOS EL ARRAY YA ESTA VACIO

	})

	//Pulsa el boton finish
	var finish = document.getElementById("finish");
	finish.addEventListener("click",function(e){

		if(arrayTabacos.length > 0){
			
			var userPurchase = {};

			var user = localStorage.getItem("activeUser");
			localStorage.setItem("lineasCompra",JSON.stringify(arrayTabacos));

			userPurchase = {
				nameUser:user,
				lineasCompra:arrayTabacos
			}
		 
			window.location.replace("payment.html");
		}else{
			alert("NO HAY PRODUCTOS PARA COMPRAR SELECCIONADOS");
		}
	})
}

	function cardsEvents(type){

		var codigo;
		var tipo;
		var marca;
		var precio;
		var img;

		if(type=="tabacoIndustrial"){
			listCajetas = industrialSearchModel.items;
			tipo = "Industrial";
		}else{
			listCajetas=liarSearchModel.items;
			tipo = "Liar";
		}
			

		//Nos devuelve un vector con todos los buttons de los cards
		var cards = document.getElementsByClassName("button-card");

		//Añadimos un click listener a cada button de cada card
		for(let i = 0; i<cards.length;i++){

			cards[i].addEventListener("click",function(e){

				//Lo primero distinguimos en que card han dado click
				var evento = e.currentTarget.id;
				//debugger

				//Una vez sabemos que id tiene el boton nos guardamos la cajeta correspondiente
				let cajeta = listCajetas[i];
				//debugger

				/*
					document.getElementById("tabaco-grid").style.visibility = "hidden";
					document.getElementById("cart-article").style.visibility = "visible";

					document.getElementById("marca-tabaco").innerHTML = cajeta.marca;
					document.getElementById("precio-tabaco").innerHTML = cajeta.precio;

				*/


				const myModal = new bootstrap.Modal(document.getElementById('articleModal'), {
		  			keyboard: false
				});
				
				document.getElementById("marca-tabaco").innerHTML = cajeta.marca;
				marca = cajeta.marca;
				document.getElementById("precio-tabaco").innerHTML = cajeta.precio;
				document.getElementById("unidades").innerHTML = "0"; //Si no se queda con el ultimo valor que tuviese
				precio = cajeta.precio;
				codigo = cajeta.codigo;
				img = cajeta.imagen;

				myModal.show();

			})
		}

		var but = document.getElementById("buttonAdd");

		//Click en addChart
		but.addEventListener("click",function(e){

			console.log(marca);
			console.log(precio);
			console.log(tipo);
			console.log(codigo);
			var uds = document.getElementById("unidades").value;	
			console.log(uds);

			if(uds>0){
			
				var lineaCompra = {};

				lineaCompra = {
					codigo:codigo,
					imagen:img,
					nombre:marca,
					tipo:tipo,
					cantidad:uds,
					precio,precio
				}
				
				arrayTabacos.push(lineaCompra);
			}else{
				alert("NO HA SELECCIONADO NINGUNA CANTIDAD");
			}

		})

	}




</script>
</html>